version: '3.8'

services:
  # Firebase Emulator Suite
  firebase-emulators:
    image: node:22-alpine
    container_name: sacred-sutra-firebase
    working_dir: /app
    command: >
      sh -c "apk add --no-cache openjdk17-jre bash &&
             npm install -g firebase-tools &&
             firebase emulators:start --only auth,firestore,storage --project demo-project"
    ports:
      - '9099:9099'  # Auth emulator
      - '8080:8080'  # Firestore emulator
      - '9199:9199'  # Storage emulator
      - '4000:4000'  # Emulator UI
    volumes:
      - ./firebase.json:/app/firebase.json:ro
      - firebase-data:/app/firebase-data
    networks:
      - tools-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:4000']
      interval: 30s
      timeout: 3s
      retries: 5
      start_period: 60s

  # Sacred Sutra Tools App
  tools:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sacred-sutra-tools
    restart: always
    ports:
      - '5174:5174'
    environment:
      NODE_ENV: production
      VITE_FIREBASE_FIRESTORE_EMULATOR_HOST: firebase-emulators
      VITE_FIREBASE_FIRESTORE_EMULATOR_PORT: 8080
      VITE_FIREBASE_AUTH_EMULATOR_HOST: firebase-emulators
      VITE_FIREBASE_AUTH_EMULATOR_PORT: 9099
      VITE_FIREBASE_STORAGE_EMULATOR_HOST: firebase-emulators
      VITE_FIREBASE_STORAGE_EMULATOR_PORT: 9199
    depends_on:
      firebase-emulators:
        condition: service_healthy
    networks:
      - tools-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:5174/health']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  firebase-data:

networks:
  tools-network:
    driver: bridge
