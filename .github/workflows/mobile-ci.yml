name: Mobile CI/CD

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'ios/**'
      - 'android/**'
      - 'capacitor.config.ts'
      - 'src/**'
      - 'package.json'
      - '.github/workflows/mobile-ci.yml'
  push:
    branches: [ master ]
    paths:
      - 'ios/**'
      - 'android/**'
      - 'capacitor.config.ts'
      - 'src/**'
      - 'package.json'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  checks: write
  pull-requests: write
  statuses: write

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  XCODE_VERSION: '15.4'

jobs:
  setup:
    name: ğŸ”§ Setup & Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}

      - name: Cache Capacitor
        uses: actions/cache@v4
        with:
          path: |
            ~/.capacitor
            android/.gradle
            ios/Pods
          key: ${{ runner.os }}-capacitor-${{ hashFiles('**/capacitor.config.ts', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-capacitor-

  web-build:
    name: ğŸŒ Build Web Assets
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}

      - name: Build Web App for Mobile
        id: build
        run: |
          echo "ğŸ—ï¸ Building web assets for mobile platforms..."
          echo "## ğŸŒ Mobile Web Build Results" >> $GITHUB_STEP_SUMMARY
          
          if npm run build:mobile; then
            echo "âœ… Web build completed successfully"
            echo "âœ… **Status:** Mobile web assets built successfully" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“± **Target:** Optimized for mobile WebView containers" >> $GITHUB_STEP_SUMMARY
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Web build failed"
            echo "âŒ **Status:** Mobile web build failed" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Action needed:** Fix build errors before mobile compilation" >> $GITHUB_STEP_SUMMARY
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload Web Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build-mobile-${{ github.sha }}
          path: dist/
          retention-days: 7

  android-build:
    name: ğŸ¤– Android Build & Test
    runs-on: ubuntu-latest
    needs: [setup, web-build]
    if: needs.web-build.outputs.build-success == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build-mobile-${{ github.sha }}
          path: dist/

      - name: Sync Capacitor
        run: |
          echo "ğŸ“± Syncing Capacitor for Android..."
          npx cap sync android
          echo "âœ… Capacitor sync completed"

      - name: Grant Execute Permission for Gradlew
        run: chmod +x android/gradlew

      - name: Build Android APK (Debug)
        id: android-build
        run: |
          echo "ğŸ¤– Building Android APK..."
          echo "## ğŸ¤– Android Build Results" >> $GITHUB_STEP_SUMMARY
          
          cd android
          if ./gradlew assembleDebug; then
            echo "âœ… Android APK built successfully"
            echo "âœ… **Status:** Debug APK built successfully" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“± **Output:** app-debug.apk ready for testing" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ **Build type:** Debug (development)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Android build failed"
            echo "âŒ **Status:** Android APK build failed" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Action needed:** Fix Android build errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run Android Tests
        run: |
          echo "ğŸ§ª Running Android unit tests..."
          cd android
          ./gradlew testDebugUnitTest
          echo "âœ… Android tests completed"

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug-${{ github.sha }}
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

      - name: Upload Android Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.sha }}
          path: android/app/build/test-results/
          retention-days: 7

  ios-build:
    name: ğŸ iOS Build & Test
    runs-on: macos-latest
    needs: [setup, web-build]
    if: needs.web-build.outputs.build-success == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          echo "âœ… CocoaPods installed"

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build-mobile-${{ github.sha }}
          path: dist/

      - name: Sync Capacitor
        run: |
          echo "ğŸ“± Syncing Capacitor for iOS..."
          npx cap sync ios
          echo "âœ… Capacitor sync completed"

      - name: Install iOS Dependencies
        run: |
          cd ios/App
          pod install
          echo "âœ… iOS dependencies installed"

      - name: Build iOS App (Debug)
        id: ios-build
        run: |
          echo "ğŸ Building iOS app..."
          echo "## ğŸ iOS Build Results" >> $GITHUB_STEP_SUMMARY
          
          cd ios/App
          if xcodebuild -workspace App.xcworkspace -scheme App -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 15' build; then
            echo "âœ… iOS app built successfully"
            echo "âœ… **Status:** iOS app built for simulator" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“± **Target:** iPhone 15 Simulator (Debug)" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ **Build type:** Debug (development)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ iOS build failed"
            echo "âŒ **Status:** iOS build failed" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Action needed:** Fix iOS build errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run iOS Tests
        run: |
          echo "ğŸ§ª Running iOS unit tests..."
          cd ios/App
          xcodebuild test -workspace App.xcworkspace -scheme App -destination 'platform=iOS Simulator,name=iPhone 15'
          echo "âœ… iOS tests completed"

      - name: Upload iOS Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs-${{ github.sha }}
          path: ~/Library/Developer/Xcode/DerivedData/
          retention-days: 7

  mobile-summary:
    name: ğŸ“± Mobile Build Summary
    runs-on: ubuntu-latest
    needs: [setup, web-build, android-build, ios-build]
    if: always()
    steps:
      - name: Mobile Build Status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Setup & Dependencies', result: '${{ needs.setup.result }}', icon: 'ğŸ”§' },
              { name: 'Web Build (Mobile)', result: '${{ needs.web-build.result }}', icon: 'ğŸŒ' },
              { name: 'Android Build', result: '${{ needs.android-build.result }}', icon: 'ğŸ¤–' },
              { name: 'iOS Build', result: '${{ needs.ios-build.result }}', icon: 'ğŸ' }
            ];

            let summary = '## ğŸ“± Mobile CI/CD Pipeline Results\n\n';
            let allPassed = true;

            // Main status table
            summary += '| Platform | Status | Result |\n';
            summary += '|----------|--------|--------|\n';

            jobs.forEach(job => {
              const result = job.result || 'unknown';
              
              const statusIcon = result === 'success' ? 'âœ…' : 
                               result === 'skipped' ? 'â­ï¸' : 
                               result === 'failure' ? 'âŒ' : 
                               result === 'cancelled' ? 'âšª' : 'âš ï¸';
              
              summary += `| ${job.icon} ${job.name} | ${statusIcon} | \`${result}\` |\n`;
              
              if (result !== 'success' && result !== 'skipped') {
                allPassed = false;
              }
            });

            summary += '\n';

            // Platform-specific results
            const webBuildSuccess = '${{ needs.web-build.outputs.build-success }}' === 'true';
            const androidResult = '${{ needs.android-build.result }}';
            const iosResult = '${{ needs.ios-build.result }}';

            summary += '### ğŸ“Š Build Details\n\n';
            
            if (webBuildSuccess) {
              summary += 'âœ… **Web Assets:** Mobile-optimized build completed\n';
            } else {
              summary += 'âŒ **Web Assets:** Build failed - blocking mobile compilation\n';
            }

            if (androidResult === 'success') {
              summary += 'âœ… **Android:** APK built successfully, ready for testing\n';
            } else if (androidResult === 'failure') {
              summary += 'âŒ **Android:** Build failed, check logs for details\n';
            } else {
              summary += 'â­ï¸ **Android:** Skipped due to web build failure\n';
            }

            if (iosResult === 'success') {
              summary += 'âœ… **iOS:** App built successfully for simulator\n';
            } else if (iosResult === 'failure') {
              summary += 'âŒ **iOS:** Build failed, check logs for details\n';
            } else {
              summary += 'â­ï¸ **iOS:** Skipped due to web build failure\n';
            }

            summary += '\n';

            // Overall status
            if (allPassed) {
              summary += '## ğŸ‰ Mobile Build Success!\n\n';
              summary += '**All mobile platforms built successfully!** ğŸ“±\n\n';
              summary += '### ğŸš€ Ready for:\n';
              summary += '- ğŸ§ª Device testing (download artifacts)\n';
              summary += '- ğŸ“± App store deployment (after release builds)\n';
              summary += '- ğŸ” Code review and merge\n';
            } else {
              summary += '## âš ï¸ Mobile Build Issues\n\n';
              summary += '**Some mobile builds failed.** Please check the issues above.\n\n';
              summary += '### ğŸ”§ How to fix:\n';
              summary += '1. Check failed job logs in the Actions tab\n';
              summary += '2. Fix platform-specific issues locally\n';
              summary += '3. Test with `npm run mobile:dev` or `npx cap run [platform]`\n';
              summary += '4. Push changes to update this build\n';
            }

            // Add artifacts info if successful
            if (allPassed) {
              summary += '\n### ğŸ“¦ Available Artifacts:\n';
              summary += '- `android-apk-debug-${{ github.sha }}` - Android APK for testing\n';
              summary += '- `web-build-mobile-${{ github.sha }}` - Web assets for mobile\n';
              summary += '- Build logs and test results for debugging\n';
            }

            summary += `\n---\nğŸ“Š **[View detailed logs](${context.payload.repository.html_url}/actions/runs/${context.runId})**`;

            // Add this as a comment to PR if it's a pull request
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

            // Add to step summary
            require('fs').appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary + '\n');