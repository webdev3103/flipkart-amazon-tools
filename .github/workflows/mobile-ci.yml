name: Mobile CI/CD

# TEMPORARILY DISABLED - Mobile build disabled for now
on:
  workflow_dispatch:  # Only allow manual triggering
  pull_request:
    branches: [ master ]
    paths:
      - 'android/**'
      - 'capacitor.config.ts'
      - 'src/**'
      - 'package.json'
      - '.github/workflows/mobile-ci.yml'
  # push:
  #   branches: [ master ]
  #   paths:
  #     - 'ios/**'
  #     - 'android/**'
  #     - 'capacitor.config.ts'
  #     - 'src/**'
  #     - 'package.json'

permissions:
  contents: read
  checks: write
  pull-requests: write
  statuses: write

env:
  NODE_VERSION: '22'
  JAVA_VERSION: '17'
  XCODE_VERSION: '15.4'

jobs:
  setup:
    name: üîß Setup & Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}

      - name: Cache Capacitor
        uses: actions/cache@v4
        with:
          path: |
            ~/.capacitor
            android/.gradle
            ios/Pods
          key: ${{ runner.os }}-capacitor-${{ hashFiles('**/capacitor.config.ts', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-capacitor-

  web-build:
    name: üåê Build Web Assets
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      build-success: ${{ steps.build.outputs.success }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}

      - name: Build Web App for Mobile
        id: build
        run: |
          echo "üèóÔ∏è Building web assets for mobile platforms..."
          echo "## üåê Mobile Web Build Results" >> $GITHUB_STEP_SUMMARY
          
          if npm run build:mobile; then
            echo "‚úÖ Web build completed successfully"
            echo "‚úÖ **Status:** Mobile web assets built successfully" >> $GITHUB_STEP_SUMMARY
            echo "üì± **Target:** Optimized for mobile WebView containers" >> $GITHUB_STEP_SUMMARY
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Web build failed"
            echo "‚ùå **Status:** Mobile web build failed" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Action needed:** Fix build errors before mobile compilation" >> $GITHUB_STEP_SUMMARY
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload Web Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build-mobile-${{ github.sha }}
          path: dist/
          retention-days: 7

  android-build:
    name: ü§ñ Android Build & Test
    runs-on: ubuntu-latest
    needs: [setup, web-build]
    if: needs.web-build.outputs.build-success == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build-mobile-${{ github.sha }}
          path: dist/

      - name: Sync Capacitor
        run: |
          echo "üì± Syncing Capacitor for Android..."
          npx cap sync android
          echo "‚úÖ Capacitor sync completed"

      - name: Grant Execute Permission for Gradlew
        run: chmod +x android/gradlew

      - name: Build Android APK (Debug)
        id: android-build
        run: |
          echo "ü§ñ Building Android APK..."
          echo "## ü§ñ Android Build Results" >> $GITHUB_STEP_SUMMARY
          
          cd android
          if ./gradlew assembleDebug; then
            echo "‚úÖ Android APK built successfully"
            echo "‚úÖ **Status:** Debug APK built successfully" >> $GITHUB_STEP_SUMMARY
            echo "üì± **Output:** app-debug.apk ready for testing" >> $GITHUB_STEP_SUMMARY
            echo "üîß **Build type:** Debug (development)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Android build failed"
            echo "‚ùå **Status:** Android APK build failed" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Action needed:** Fix Android build errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run Android Tests
        run: |
          echo "üß™ Running Android unit tests..."
          cd android
          ./gradlew testDebugUnitTest
          echo "‚úÖ Android tests completed"

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug-${{ github.sha }}
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

      - name: Upload Android Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.sha }}
          path: android/app/build/test-results/
          retention-days: 7

  ios-build:
    name: üçé iOS Build & Test
    runs-on: macos-latest
    needs: [setup, web-build]
    if: needs.web-build.outputs.build-success == 'true' && github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          echo "‚úÖ CocoaPods installed"

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build-mobile-${{ github.sha }}
          path: dist/

      - name: Sync Capacitor
        run: |
          echo "üì± Syncing Capacitor for iOS..."
          npx cap sync ios
          echo "‚úÖ Capacitor sync completed"

      - name: Install iOS Dependencies
        run: |
          cd ios/App
          pod install
          echo "‚úÖ iOS dependencies installed"

      - name: Build iOS App (Debug)
        id: ios-build
        run: |
          echo "üçé Building iOS app..."
          echo "## üçé iOS Build Results" >> $GITHUB_STEP_SUMMARY
          
          cd ios/App
          if xcodebuild -workspace App.xcworkspace -scheme App -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 15' build; then
            echo "‚úÖ iOS app built successfully"
            echo "‚úÖ **Status:** iOS app built for simulator" >> $GITHUB_STEP_SUMMARY
            echo "üì± **Target:** iPhone 15 Simulator (Debug)" >> $GITHUB_STEP_SUMMARY
            echo "üîß **Build type:** Debug (development)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå iOS build failed"
            echo "‚ùå **Status:** iOS build failed" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Action needed:** Fix iOS build errors" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run iOS Tests
        run: |
          echo "üß™ Running iOS unit tests..."
          cd ios/App
          xcodebuild test -workspace App.xcworkspace -scheme App -destination 'platform=iOS Simulator,name=iPhone 15'
          echo "‚úÖ iOS tests completed"

      - name: Upload iOS Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs-${{ github.sha }}
          path: ~/Library/Developer/Xcode/DerivedData/
          retention-days: 7

  mobile-summary:
    name: üì± Mobile Build Summary
    runs-on: ubuntu-latest
    needs: [setup, web-build, android-build, ios-build]
    if: always()
    steps:
      - name: Mobile Build Status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Setup & Dependencies', result: '${{ needs.setup.result }}', icon: 'üîß' },
              { name: 'Web Build (Mobile)', result: '${{ needs.web-build.result }}', icon: 'üåê' },
              { name: 'Android Build', result: '${{ needs.android-build.result }}', icon: 'ü§ñ' },
              { name: 'iOS Build', result: '${{ needs.ios-build.result }}', icon: 'üçé' }
            ];

            let summary = '## üì± Mobile CI/CD Pipeline Results\n\n';
            let allPassed = true;

            // Main status table
            summary += '| Platform | Status | Result |\n';
            summary += '|----------|--------|--------|\n';

            jobs.forEach(job => {
              const result = job.result || 'unknown';
              
              const statusIcon = result === 'success' ? '‚úÖ' : 
                               result === 'skipped' ? '‚è≠Ô∏è' : 
                               result === 'failure' ? '‚ùå' : 
                               result === 'cancelled' ? '‚ö™' : '‚ö†Ô∏è';
              
              summary += `| ${job.icon} ${job.name} | ${statusIcon} | \`${result}\` |\n`;
              
              if (result !== 'success' && result !== 'skipped') {
                allPassed = false;
              }
            });

            summary += '\n';

            // Platform-specific results
            const webBuildSuccess = '${{ needs.web-build.outputs.build-success }}' === 'true';
            const androidResult = '${{ needs.android-build.result }}';
            const iosResult = '${{ needs.ios-build.result }}';

            summary += '### üìä Build Details\n\n';
            
            if (webBuildSuccess) {
              summary += '‚úÖ **Web Assets:** Mobile-optimized build completed\n';
            } else {
              summary += '‚ùå **Web Assets:** Build failed - blocking mobile compilation\n';
            }

            if (androidResult === 'success') {
              summary += '‚úÖ **Android:** APK built successfully, ready for testing\n';
            } else if (androidResult === 'failure') {
              summary += '‚ùå **Android:** Build failed, check logs for details\n';
            } else {
              summary += '‚è≠Ô∏è **Android:** Skipped due to web build failure\n';
            }

            if (iosResult === 'success') {
              summary += '‚úÖ **iOS:** App built successfully for simulator\n';
            } else if (iosResult === 'failure') {
              summary += '‚ùå **iOS:** Build failed, check logs for details\n';
            } else {
              if (webBuildSuccess) {
                summary += '‚è≠Ô∏è **iOS:** Skipped (disabled for this event)\n';
              } else {
                summary += '‚è≠Ô∏è **iOS:** Skipped due to web build failure\n';
              }
            }

            summary += '\n';

            // Overall status
            if (allPassed) {
              summary += '## üéâ Mobile Build Success!\n\n';
              summary += '**All mobile platforms built successfully!** üì±\n\n';
              summary += '### üöÄ Ready for:\n';
              summary += '- üß™ Device testing (download artifacts)\n';
              summary += '- üì± App store deployment (after release builds)\n';
              summary += '- üîç Code review and merge\n';
            } else {
              summary += '## ‚ö†Ô∏è Mobile Build Issues\n\n';
              summary += '**Some mobile builds failed.** Please check the issues above.\n\n';
              summary += '### üîß How to fix:\n';
              summary += '1. Check failed job logs in the Actions tab\n';
              summary += '2. Fix platform-specific issues locally\n';
              summary += '3. Test with `npm run mobile:dev` or `npx cap run [platform]`\n';
              summary += '4. Push changes to update this build\n';
            }

            // Add artifacts info if successful
            if (allPassed) {
              summary += '\n### üì¶ Available Artifacts:\n';
              summary += '- `android-apk-debug-${{ github.sha }}` - Android APK for testing\n';
              summary += '- `web-build-mobile-${{ github.sha }}` - Web assets for mobile\n';
              summary += '- Build logs and test results for debugging\n';
            }

            summary += `\n---\nüìä **[View detailed logs](${context.payload.repository.html_url}/actions/runs/${context.runId})**`;

            // Add this as a comment to PR if it's a pull request
            if (context.eventName === 'pull_request') {
              // Add unique identifier for this workflow's comment
              const commentIdentifier = '<!-- MOBILE_CI_WORKFLOW_STATUS -->';
              const commentBody = commentIdentifier + '\n' + summary;

              // Find existing comment from this workflow
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const existingComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes(commentIdentifier)
              );

              // Update existing comment or create new one
              if (existingComment) {
                await github.rest.issues.updateComment({
                  comment_id: existingComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                console.log('‚úÖ Updated existing mobile CI PR comment');
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                console.log('‚úÖ Created new mobile CI PR comment');
              }
            }

            // Add to step summary
            require('fs').appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary + '\n');