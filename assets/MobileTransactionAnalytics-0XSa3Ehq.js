import{j as e,B as n,C as S,ai as V,h as x,aU as q,k as C,aV as z,aW as X,A,aX as Y,aY as M}from"./mui-vendor-DlldRxor.js";import{i as $,a as l}from"./react-vendor-C0s_J9t-.js";import{M as G}from"./MobileAppShell-dHUJWRrR.js";import{M as h}from"./MobileCard-BmxjauOU.js";import{u as J}from"./usePullToRefresh-C2FNOxJ5.js";import{i as K,j as k,D as E,A as R,U as Q}from"./index-D4QRAU_W.js";import{T as Z}from"./transactionAnalysis.service-DrepQx6p.js";import{S as _,O as ee,P as ae,R as te}from"./transactionAnalytics.page-DoeP6L_3.js";import"./redux-vendor-tKFe_QvA.js";import"./firebase-vendor-40dJGoDN.js";import"./utils-vendor-CFocuF-S.js";import"./pdf-vendor-DisdNAgy.js";import"./DataTable-CqcHOsap.js";import"./FormattedCurrency-CWfs6hb7.js";function W(o){const{children:f,value:s,index:c,...m}=o;return e.jsx("div",{hidden:s!==c,...m,children:s===c&&e.jsx(n,{sx:{pt:2},children:f})})}const ge=()=>{var w,P;const o=K(),f=$(),{items:s,loading:c,error:m}=k(t=>t.transactions),{items:y}=k(t=>t.products),[d,U]=l.useState(null),[g,I]=l.useState(0),[u,L]=l.useState({minDate:null,maxDate:null}),[b,v]=l.useState(!1),[T,j]=l.useState(null),{state:D,containerRef:B}=J(async()=>{await Promise.all([o(E()).unwrap(),o(R({})).unwrap()])},{threshold:80,enabled:!0});l.useEffect(()=>{(async()=>{try{await Promise.all([o(E()),o(R({}))])}catch(a){console.error("Error loading data:",a)}})()},[o]),l.useEffect(()=>{(async()=>{if(s.length>0&&y.length>0)try{v(!0);const a=new Map(y.map(r=>[r.sku.toLowerCase(),r])),i=s.map(r=>({...r,product:{...r.product,...a.get(r.sku.toLowerCase())}})),p=i.map(r=>new Date(r.orderDate));L({minDate:new Date(Math.min(...p.map(r=>r.getTime()))),maxDate:new Date(Math.max(...p.map(r=>r.getTime())))});const O=await new Z(i,a).analyze();U(O)}catch(a){console.error("Error analyzing transactions:",a)}finally{v(!1)}})()},[s,y]);const F=l.useMemo(()=>{if(!s.length)return[];const t=new Map;return s.forEach(a=>{a.sku&&(t.has(a.sku)||t.set(a.sku,{sku:a.sku,description:a.description||a.sku}))}),Array.from(t.values())},[s]),N=async t=>{var a;try{j(null);const i=(a=t.target.files)==null?void 0:a[0];if(!i)throw new Error("No file selected");const p=await new te(i).extract();await o(Q(p)).unwrap(),t.target.value=""}catch(i){j(i instanceof Error?i.message:"Failed to upload file")}},H=(t,a)=>{I(a)};return e.jsx(G,{pageTitle:"Analytics",children:e.jsxs(n,{ref:B,sx:{display:"flex",flexDirection:"column",flex:1,overflow:"auto",backgroundColor:"background.default",px:2,py:2},children:[D.isRefreshing&&e.jsx(n,{sx:{display:"flex",justifyContent:"center",py:2},children:e.jsx(S,{size:24})}),s.length>0&&e.jsx(n,{sx:{mb:2,display:"flex",justifyContent:"center"},children:e.jsx(V,{label:`${s.length} Transactions`,color:"primary",size:"medium"})}),(c||b)&&!D.isRefreshing&&e.jsx(h,{sx:{mb:2},children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"center",gap:1},children:[e.jsx(S,{size:20}),e.jsx(x,{variant:"body2",color:"primary.main",children:c?"Loading...":"Analyzing prices..."})]})}),e.jsxs(h,{sx:{mb:2,borderColor:u.minDate?"info.main":"divider"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(q,{sx:{color:"info.main",mr:1,fontSize:20}}),e.jsx(x,{variant:"h6",sx:{fontWeight:600},children:u.minDate?"Transaction Period":"No Data"})]}),u.minDate?e.jsxs(x,{variant:"body2",color:"text.secondary",children:[(w=u.minDate)==null?void 0:w.toLocaleDateString()," to"," ",(P=u.maxDate)==null?void 0:P.toLocaleDateString()]}):e.jsx(x,{variant:"body2",color:"text.secondary",children:"Upload a transaction file to begin analysis"})]}),e.jsxs(n,{sx:{mb:2,display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(C,{variant:"contained",component:"label",disabled:c,startIcon:e.jsx(z,{}),fullWidth:!0,sx:{py:1.5,fontWeight:600,textTransform:"none",minHeight:56},children:["Upload Transaction File",e.jsx("input",{type:"file",hidden:!0,accept:".csv,.xlsx",onChange:N})]}),e.jsx(C,{variant:"outlined",color:"secondary",onClick:()=>f("/products"),disabled:!F.length,startIcon:e.jsx(X,{}),fullWidth:!0,sx:{py:1.5,fontWeight:600,textTransform:"none",minHeight:56},children:"Manage Product Prices"})]}),m&&e.jsx(A,{severity:"error",sx:{mb:2},children:m}),T&&e.jsx(A,{severity:"error",sx:{mb:2},onClose:()=>j(null),children:T}),d&&e.jsxs(e.Fragment,{children:[e.jsx(n,{sx:{mb:2},children:e.jsx(_,{summary:d})}),e.jsxs(h,{sx:{mb:2,p:0},children:[e.jsxs(Y,{value:g,onChange:H,variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider","& .MuiTab-root":{fontWeight:600,textTransform:"none",minHeight:48}},children:[e.jsx(M,{label:"Orders"}),e.jsx(M,{label:"Products"})]}),e.jsxs(n,{sx:{px:2},children:[e.jsx(W,{value:g,index:0,children:e.jsx(ee,{transactions:(d==null?void 0:d.analyzedTransactions)||[]})}),e.jsx(W,{value:g,index:1,children:e.jsx(ae,{transactions:s,summary:d})})]})]})]}),!d&&!c&&!b&&e.jsx(h,{children:e.jsxs(n,{sx:{textAlign:"center",py:4},children:[e.jsx(z,{sx:{fontSize:48,opacity:.3,mb:2,color:"text.secondary"}}),e.jsx(x,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No transaction data available"}),e.jsx(x,{variant:"body2",color:"text.secondary",children:"Upload a transaction file to view analytics"})]})})]})})};export{ge as MobileTransactionAnalytics};
