import{j as e,al as Fe,am as Ae,B as r,W as Me,h as n,an as ke,aj as K,ag as P,ai as m,A as F,ap as Ie,k as ie,V as b,ay as v,C as _,N as oe,a9 as u,u as Be,bb as ce,bc as T,bx as de,q as L,by as xe,bz as he,I as p,ar as me,bA as ue,aA as je,ba as I,aE as R,aO as G,S as pe,Q as De}from"./mui-vendor-DlldRxor.js";import{a as i}from"./react-vendor-C0s_J9t-.js";import{p as z,r as Pe}from"./pdfStorageService-DGuhzLre.js";import{u as We}from"./index-D4QRAU_W.js";import{M as Ee}from"./MobileAppShell-dHUJWRrR.js";import"./firebase-vendor-40dJGoDN.js";import"./redux-vendor-tKFe_QvA.js";import"./utils-vendor-CFocuF-S.js";import"./pdf-vendor-DisdNAgy.js";const Ue=a=>{if(a===0)return"0 Bytes";const x=1024,o=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(a)/Math.log(x));return parseFloat((a/Math.pow(x,c)).toFixed(2))+" "+o[c]},fe=({open:a,onClose:x,onConfirm:o,itemType:c,itemName:j,folderStats:d})=>{const f=c==="folder",h=d&&d.fileCount>1;return e.jsxs(Fe,{open:a,onClose:x,maxWidth:"sm",fullWidth:!0,"aria-labelledby":"delete-dialog-title",children:[e.jsx(Ae,{id:"delete-dialog-title",children:e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Me,{color:"warning"}),e.jsxs(n,{variant:"h6",children:["Delete ",f?"Folder":"File"]})]})}),e.jsxs(ke,{children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[f?e.jsx(K,{color:"primary",sx:{fontSize:40}}):e.jsx(P,{color:"error",sx:{fontSize:40}}),e.jsxs(r,{children:[e.jsx(n,{variant:"h6",component:"div",sx:{wordBreak:"break-word"},children:j}),d&&e.jsxs(r,{sx:{display:"flex",gap:1,mt:1},children:[e.jsx(m,{label:`${d.fileCount} file${d.fileCount!==1?"s":""}`,size:"small",variant:"outlined"}),e.jsx(m,{label:Ue(d.totalSize),size:"small",variant:"outlined"})]})]})]}),e.jsx(F,{severity:"warning",sx:{mb:2},children:e.jsx(n,{variant:"body2",children:f?e.jsxs(e.Fragment,{children:["This will permanently delete the folder and"," ",e.jsx("strong",{children:d?`all ${d.fileCount} file${d.fileCount!==1?"s":""}`:"all files"})," ","inside it."]}):"This will permanently delete the file."})}),h&&e.jsx(F,{severity:"error",sx:{mb:2},children:e.jsxs(n,{variant:"body2",fontWeight:"bold",children:["⚠️ This folder contains ",d==null?void 0:d.fileCount," files. This action cannot be undone!"]})}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Are you sure you want to continue? This action cannot be undone."})]}),e.jsxs(Ie,{sx:{p:2},children:[e.jsx(ie,{onClick:x,variant:"outlined",children:"Cancel"}),e.jsxs(ie,{onClick:o,variant:"contained",color:"error",autoFocus:!0,children:["Delete ",f?"Folder":"File"]})]})]})},Ne=a=>{if(a===0)return"0 Bytes";const x=1024,o=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(a)/Math.log(x));return parseFloat((a/Math.pow(x,c)).toFixed(2))+" "+o[c]},ge=()=>{const[a,x]=i.useState(null),[o,c]=i.useState(!0),[j,d]=i.useState(null),f=async()=>{try{c(!0),d(null);const h=await z.listUserFolders();let C=0,W=0;if(Array.isArray(h))for(const g of h)C+=g.fileCount,W+=g.totalSize;else console.warn("Expected folders to be an array, got:",typeof h);x({totalFolders:Array.isArray(h)?h.length:0,totalFiles:C,totalSize:W})}catch(h){const C=h instanceof Error?h.message:"Failed to load storage statistics";d(C),console.error("Error loading storage stats:",h)}finally{c(!1)}};return i.useEffect(()=>{f()},[]),o?e.jsx(b,{children:e.jsx(v,{children:e.jsx(r,{sx:{display:"flex",justifyContent:"center",py:2},children:e.jsx(_,{size:24})})})}):j?e.jsxs(F,{severity:"error",children:["Failed to load storage statistics: ",j]}):a?e.jsx(b,{children:e.jsxs(v,{children:[e.jsxs(n,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(oe,{color:"primary"}),"Storage Overview"]}),e.jsxs(u,{container:!0,spacing:2,children:[e.jsx(u,{item:!0,xs:12,sm:4,children:e.jsxs(r,{sx:{textAlign:"center"},children:[e.jsx(K,{color:"primary",sx:{fontSize:40,mb:1}}),e.jsx(n,{variant:"h4",component:"div",children:a.totalFolders}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["Folder",a.totalFolders!==1?"s":""]})]})}),e.jsx(u,{item:!0,xs:12,sm:4,children:e.jsxs(r,{sx:{textAlign:"center"},children:[e.jsx(P,{color:"error",sx:{fontSize:40,mb:1}}),e.jsx(n,{variant:"h4",component:"div",children:a.totalFiles}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:["File",a.totalFiles!==1?"s":""]})]})}),e.jsx(u,{item:!0,xs:12,sm:4,children:e.jsxs(r,{sx:{textAlign:"center"},children:[e.jsx(oe,{color:"success",sx:{fontSize:40,mb:1}}),e.jsx(n,{variant:"h4",component:"div",children:Ne(a.totalSize)}),e.jsx(n,{variant:"body2",color:"text.secondary",children:"Total Size"})]})})]}),a.totalFiles===0&&e.jsx(r,{sx:{mt:2,textAlign:"center"},children:e.jsx(m,{label:"No files uploaded yet",variant:"outlined",color:"default"})})]})}):null},B=a=>{if(a===0)return"0 Bytes";const x=1024,o=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(a)/Math.log(x));return parseFloat((a/Math.pow(x,c)).toFixed(2))+" "+o[c]},D=a=>{const o=Math.floor((new Date().getTime()-a.getTime())/(1e3*60));if(o<1)return"Just now";if(o<60)return`${o}m ago`;const c=Math.floor(o/60);if(c<24)return`${c}h ago`;const j=Math.floor(c/24);return j<7?`${j}d ago`:a.toLocaleDateString()},_e=()=>{const a=Be(),x=We(),[o,c]=i.useState(""),[j,d]=i.useState([]),[f,h]=i.useState([]),[C,W]=i.useState([]),[g,S]=i.useState(!0),[N,w]=i.useState(null),[A,ye]=i.useState(!1),[Y,be]=i.useState([]),[q,ve]=i.useState({}),[J,Q]=i.useState(!1),[X,H]=i.useState(!1),[l,$]=i.useState(null),[Z,M]=i.useState(!1),[ee,V]=i.useState(""),[se,te]=i.useState("success");i.useEffect(()=>{(async()=>{try{const t=await Pe.hasAdminAccess();Q(t)}catch(t){console.error("Error checking admin access:",t),Q(!1)}})()},[]);const E=async()=>{try{if(S(!0),w(null),o===""){const s=await z.listAllFolders();h(s),W([])}else{const s=await z.listFolderContents(o);W(s),h([])}}catch(s){const t=s instanceof Error?s.message:"Failed to load storage contents";w(t),console.error("Error loading storage contents:",s)}finally{S(!1)}},Ce=()=>{if(o===""){d([]);return}const s=o.split("/").filter(Boolean),t=[];let y="";for(let k=2;k<s.length;k++)y+=(y?"/":"")+s[k],t.push({name:s[k],path:`pdfs/${s[1]}/${y}`});d(t)},U=s=>{c(s),Ce()},re=s=>{U(s.path)},Se=async()=>{try{S(!0),w(null);const s={page:1,pageSize:50,sortBy:"uploadDate",sortOrder:"desc"},t=await z.listAllUserPdfs(s);be(t.pdfs);const y=await z.getUserDetailsForPdfs(t.pdfs.map(k=>k.fileId));ve(y)}catch(s){const t=s instanceof Error?s.message:"Failed to load PDFs";w(t),console.error("Error loading all user PDFs:",s)}finally{S(!1)}},O=(s,t)=>{$({type:s,item:t}),H(!0)},ne=async()=>{if(l)try{S(!0),l.type==="folder"?(await z.deleteFolderRecursive(l.item.path),V("Folder deleted successfully")):(await z.deleteFile(l.item.path),V("File deleted successfully")),te("success"),M(!0),await E()}catch(s){const t=s instanceof Error?s.message:"Failed to delete item";w(t),V(t),te("error"),M(!0)}finally{S(!1),H(!1),$(null)}},ae=s=>{window.open(s.downloadUrl,"_blank")},le=async s=>{try{ye(s),S(!0),s?await Se():await E()}catch(t){console.error("Error toggling view:",t)}};i.useEffect(()=>{E()},[o]);const we=()=>e.jsx(u,{container:!0,spacing:2,children:Y.map(s=>{const t=q[s.metadata.userId]||{};return e.jsx(u,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(b,{children:[e.jsxs(v,{children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(ue,{src:t.photoURL,sx:{mr:2,width:40,height:40},children:t.displayName?t.displayName[0]:e.jsx(je,{})}),e.jsxs(r,{children:[e.jsx(n,{variant:"subtitle1",children:t.displayName||"Unknown User"}),e.jsx(n,{variant:"body2",color:"text.secondary",children:t.email})]})]}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(P,{color:"error",sx:{mr:1}}),e.jsx(n,{variant:"subtitle2",noWrap:!0,children:s.metadata.originalFileName})]}),e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsx(m,{label:B(s.metadata.fileSize),size:"small",variant:"outlined"}),e.jsx(m,{label:D(new Date(s.metadata.uploadedAt)),size:"small",variant:"outlined"})]})]}),e.jsx(I,{children:e.jsx(p,{color:"primary",onClick:()=>window.open(s.downloadUrl,"_blank"),children:e.jsx(R,{})})})]})},s.fileId)})}),ze=()=>e.jsxs(u,{container:!0,spacing:2,children:[f.map(s=>e.jsx(u,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(b,{sx:{cursor:"pointer",transition:"all 0.2s","&:hover":{transform:"translateY(-2px)",boxShadow:a.shadows[4]}},children:[e.jsxs(v,{onClick:()=>re(s),sx:{pb:1},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(K,{color:"primary",sx:{mr:1,fontSize:32}}),e.jsx(n,{variant:"h6",component:"div",noWrap:!0,children:s.name})]}),e.jsxs(n,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:[s.fileCount," file",s.fileCount!==1?"s":""]}),e.jsx(n,{variant:"body2",color:"text.secondary",children:B(s.totalSize)}),e.jsx(m,{label:D(s.lastModified),size:"small",sx:{mt:1}})]}),e.jsx(I,{sx:{pt:0},children:e.jsx(p,{size:"small",color:"error",onClick:t=>{t.stopPropagation(),O("folder",s)},"aria-label":"delete folder",children:e.jsx(G,{})})})]})},s.path)),C.map(s=>e.jsx(u,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(b,{sx:{transition:"all 0.2s","&:hover":{transform:"translateY(-2px)",boxShadow:a.shadows[4]}},children:[e.jsxs(v,{sx:{pb:1},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(P,{color:"error",sx:{mr:1,fontSize:32}}),e.jsx(n,{variant:"h6",component:"div",noWrap:!0,title:s.name,children:s.name})]}),e.jsx(n,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:B(s.size)}),e.jsx(m,{label:D(s.lastModified),size:"small",sx:{mt:1}})]}),e.jsxs(I,{sx:{pt:0,justifyContent:"space-between"},children:[e.jsx(p,{size:"small",color:"primary",onClick:()=>ae(s),"aria-label":"download file",children:e.jsx(R,{})}),e.jsx(p,{size:"small",color:"error",onClick:()=>O("file",s),"aria-label":"delete file",children:e.jsx(G,{})})]})]})},s.path))]});return x?e.jsx(Ee,{pageTitle:"Storage",children:e.jsxs(r,{sx:{p:2},children:[J&&e.jsx(r,{sx:{mb:2,display:"flex",justifyContent:"center"},children:e.jsxs(ce,{value:A,exclusive:!0,onChange:(s,t)=>t!==null&&le(t),color:"primary",size:"small",fullWidth:!0,sx:{maxWidth:300},children:[e.jsx(T,{value:!1,children:"My Files"}),e.jsx(T,{value:!0,children:"All Users"})]})}),e.jsx(r,{sx:{mb:2},children:e.jsx(ge,{})}),!A&&j.length>0&&e.jsx(r,{sx:{mb:2},children:e.jsxs(de,{separator:e.jsx(he,{fontSize:"small"}),maxItems:3,sx:{fontSize:"0.875rem"},children:[e.jsxs(L,{component:"button",variant:"body2",onClick:()=>U(""),sx:{display:"flex",alignItems:"center",textDecoration:"none"},children:[e.jsx(xe,{sx:{mr:.5},fontSize:"small"}),"Home"]}),j.map(s=>e.jsx(L,{component:"button",variant:"body2",onClick:()=>U(s.path),sx:{textDecoration:"none"},children:s.name},s.path))]})}),e.jsx(r,{sx:{mb:2,display:"flex",justifyContent:"flex-end"},children:e.jsx(p,{onClick:E,disabled:g,color:"primary",sx:{minWidth:44,minHeight:44},children:e.jsx(me,{})})}),N&&e.jsx(F,{severity:"error",sx:{mb:2},onClose:()=>w(null),children:N}),g&&e.jsx(r,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(_,{})}),!g&&e.jsx(u,{container:!0,spacing:2,children:A?Y.map(s=>{var y;const t=q[s.metadata.userId]||{};return e.jsx(u,{item:!0,xs:12,sm:6,children:e.jsxs(b,{children:[e.jsxs(v,{children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(ue,{src:t.photoURL,sx:{mr:1,width:32,height:32},children:((y=t.displayName)==null?void 0:y[0])||e.jsx(je,{})}),e.jsxs(r,{children:[e.jsx(n,{variant:"subtitle2",noWrap:!0,children:t.displayName||"Unknown"}),e.jsx(n,{variant:"caption",color:"text.secondary",noWrap:!0,children:t.email})]})]}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(P,{color:"error",sx:{mr:1,fontSize:20}}),e.jsx(n,{variant:"body2",noWrap:!0,children:s.metadata.originalFileName})]}),e.jsxs(r,{sx:{display:"flex",gap:1},children:[e.jsx(m,{label:B(s.metadata.fileSize),size:"small"}),e.jsx(m,{label:D(new Date(s.metadata.uploadedAt)),size:"small"})]})]}),e.jsx(I,{children:e.jsx(p,{color:"primary",onClick:()=>window.open(s.downloadUrl,"_blank"),sx:{minWidth:44,minHeight:44},children:e.jsx(R,{})})})]})},s.fileId)}):e.jsxs(e.Fragment,{children:[f.map(s=>e.jsx(u,{item:!0,xs:12,sm:6,children:e.jsxs(b,{onClick:()=>re(s),children:[e.jsxs(v,{sx:{pb:1},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(K,{color:"primary",sx:{mr:1}}),e.jsx(n,{variant:"subtitle1",noWrap:!0,children:s.name})]}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:[s.fileCount," file",s.fileCount!==1?"s":""]}),e.jsxs(r,{sx:{display:"flex",gap:1,mt:1},children:[e.jsx(m,{label:B(s.totalSize),size:"small"}),e.jsx(m,{label:D(s.lastModified),size:"small"})]})]}),e.jsx(I,{sx:{pt:0},children:e.jsx(p,{size:"small",color:"error",onClick:t=>{t.stopPropagation(),O("folder",s)},sx:{minWidth:44,minHeight:44},children:e.jsx(G,{})})})]})},s.path)),C.map(s=>e.jsx(u,{item:!0,xs:12,sm:6,children:e.jsxs(b,{children:[e.jsxs(v,{sx:{pb:1},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(P,{color:"error",sx:{mr:1}}),e.jsx(n,{variant:"subtitle1",noWrap:!0,children:s.name})]}),e.jsxs(r,{sx:{display:"flex",gap:1},children:[e.jsx(m,{label:B(s.size),size:"small"}),e.jsx(m,{label:D(s.lastModified),size:"small"})]})]}),e.jsxs(I,{sx:{pt:0},children:[e.jsx(p,{size:"small",color:"primary",onClick:()=>ae(s),sx:{minWidth:44,minHeight:44},children:e.jsx(R,{})}),e.jsx(p,{size:"small",color:"error",onClick:()=>O("file",s),sx:{minWidth:44,minHeight:44},children:e.jsx(G,{})})]})]})},s.path))]})}),e.jsx(fe,{open:X,onClose:()=>{H(!1),$(null)},onConfirm:ne,itemType:(l==null?void 0:l.type)||"file",itemName:(l==null?void 0:l.item.name)||"",folderStats:(l==null?void 0:l.type)==="folder"?{fileCount:l.item.fileCount,totalSize:l.item.totalSize}:void 0}),e.jsx(pe,{open:Z,autoHideDuration:6e3,onClose:()=>M(!1),children:e.jsx(F,{onClose:()=>M(!1),severity:se,sx:{width:"100%"},children:ee})})]})}):e.jsxs(De,{maxWidth:!1,sx:{py:3},children:[e.jsxs(r,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(r,{children:[e.jsx(n,{variant:"h4",component:"h1",gutterBottom:!0,children:"Storage Management"}),e.jsx(n,{variant:"body1",color:"text.secondary",children:A?"All Users' Files":"Manage your uploaded PDF files and folders"})]}),J&&e.jsxs(ce,{value:A,exclusive:!0,onChange:(s,t)=>t!==null&&le(t),color:"primary","data-testid":"toggle-group",children:[e.jsx(T,{value:!1,"data-testid":"toggle-button-false",children:"My Files"}),e.jsx(T,{value:!0,"data-testid":"toggle-button-true",children:"All Users"})]})]}),e.jsx(r,{sx:{mb:3},children:e.jsx(ge,{})}),e.jsx(r,{sx:{mb:3},children:e.jsxs(de,{separator:e.jsx(he,{fontSize:"small"}),"aria-label":"folder navigation",children:[e.jsxs(L,{component:"button",variant:"body1",onClick:()=>U(""),sx:{display:"flex",alignItems:"center",textDecoration:"none","&:hover":{textDecoration:"underline"}},children:[e.jsx(xe,{sx:{mr:.5},fontSize:"inherit"}),"All Files"]}),j.map(s=>e.jsx(L,{component:"button",variant:"body1",onClick:()=>U(s.path),sx:{textDecoration:"none","&:hover":{textDecoration:"underline"}},children:s.name},s.path))]})}),e.jsx(r,{sx:{mb:3,display:"flex",justifyContent:"flex-end"},children:e.jsx(p,{onClick:E,disabled:g,"aria-label":"refresh",color:"primary",children:e.jsx(me,{})})}),N&&e.jsx(F,{severity:"error",sx:{mb:3},onClose:()=>w(null),children:N}),g&&e.jsx(r,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(_,{})}),!g&&(A?we():ze()),e.jsx(fe,{open:X,onClose:()=>{H(!1),$(null)},onConfirm:ne,itemType:(l==null?void 0:l.type)||"file",itemName:(l==null?void 0:l.item.name)||"",folderStats:(l==null?void 0:l.type)==="folder"?{fileCount:l.item.fileCount,totalSize:l.item.totalSize}:void 0}),e.jsx(pe,{open:Z,autoHideDuration:6e3,onClose:()=>M(!1),children:e.jsx(F,{onClose:()=>M(!1),severity:se,sx:{width:"100%"},children:ee})})]})};export{_e as StorageManagementPage};
