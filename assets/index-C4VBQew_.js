import{u as T,d as D,j as e,al as W,am as H,h as u,I as K,a as q,an as z,ac as E,B as g,k as v,b9 as _,aZ as U,D as V,Y as G,as as B,ap as Q}from"./mui-vendor-DlldRxor.js";import{a as o}from"./react-vendor-C0s_J9t-.js";import{a0 as X,bf as Y}from"./index-D4QRAU_W.js";import{u as Z}from"./useEnhancedCamera-C15S_UMc.js";import"./redux-vendor-tKFe_QvA.js";import"./firebase-vendor-40dJGoDN.js";import"./utils-vendor-CFocuF-S.js";import"./pdf-vendor-DisdNAgy.js";const oe=({open:m,onClose:I,onScanSuccess:n,onScanError:J})=>{const[l,y]=o.useState("camera"),[x,P]=o.useState(""),[c,f]=o.useState(!1),w=T(),h=D(w.breakpoints.down("md")),A=D(w.breakpoints.down("sm")),i=o.useRef(null),{feedback:M,isVisible:R,showError:d,showInfo:p,hideFeedback:b}=X({defaultDuration:3e3,autoHide:!0}),r=Z({targetRef:i,timeout:3e4,useEnvironmentCamera:!0}),O=o.useCallback(a=>{if(c)return;const t=a.codeResult.code;if(!t||t.length<4){d("Invalid barcode detected. Please try again.");return}f(!0),p("Product barcode detected!");const s={success:!0,barcodeId:t};n==null||n(s)},[c,n,d,p]);o.useEffect(()=>{if(m&&l==="camera"&&!r.isActive)(async()=>{try{await r.startCamera(),r.setOnDetected(O)}catch(t){console.error("ProductIdentificationScanner: Failed to start camera:",t),d("Failed to start camera. Please check permissions.")}})();else if(!m||l!=="camera"){if(r.removeOnDetected(),i.current){const t=i.current.querySelector("video");if(t&&t.srcObject){const s=t.srcObject;s&&(s.getTracks().forEach(j=>j.stop()),t.srcObject=null)}}(async()=>{try{await r.stopCamera()}catch(t){console.warn("ProductIdentificationScanner: Error stopping camera:",t)}})()}},[m,l,r,O,d]),o.useEffect(()=>()=>{r.isActive&&(r.stopCamera().catch(a=>{console.warn("ProductIdentificationScanner: Error in cleanup camera stop:",a)}),r.removeOnDetected())},[r]),o.useEffect(()=>{m&&(P(""),f(!1),y("camera"),b())},[m,b]);const C=o.useCallback(()=>{const a=x.trim();if(!a){d("Please enter a barcode");return}if(a.length<4){d("Barcode must be at least 4 characters long");return}f(!0),p("Processing barcode...");const t={success:!0,barcodeId:a};n==null||n(t)},[x,n,d,p]),S=o.useCallback(a=>{a.key==="Enter"&&(a.preventDefault(),C())},[C]),k=o.useCallback(async()=>{try{if(r.removeOnDetected(),i.current){const a=i.current.querySelector("video");if(a&&a.srcObject){const t=a.srcObject;t&&(t.getTracks().forEach(s=>{s.stop()}),a.srcObject=null)}}await r.stopCamera().catch(console.log)}catch(a){console.warn("ProductIdentificationScanner: Error stopping camera:",a)}f(!1),b(),I()},[r,I,b]);return e.jsxs(W,{open:m,onClose:(a,t)=>{if(i.current){const s=i.current.querySelector("video");if(s&&s.srcObject){const j=s.srcObject;j&&(j.getTracks().forEach(F=>F.stop()),s.srcObject=null)}}k()},maxWidth:"sm",fullWidth:!0,fullScreen:A,PaperProps:{sx:{minHeight:h?"100vh":"600px",maxHeight:h?"100vh":"80vh"}},children:[e.jsxs(H,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:1},children:[e.jsx(u,{variant:"h6",component:"div",sx:{fontWeight:600},children:"Product Scanner"}),e.jsx(K,{onClick:k,disabled:c,"aria-label":"close",sx:{color:"text.secondary"},children:e.jsx(q,{})})]}),e.jsx(z,{sx:{pb:2},children:e.jsxs(E,{spacing:3,children:[e.jsxs(g,{children:[e.jsx(u,{variant:"subtitle2",sx:{mb:1,fontWeight:500},children:"Scanning Method"}),e.jsxs(E,{direction:"row",spacing:1,children:[e.jsx(v,{variant:l==="camera"?"contained":"outlined",startIcon:e.jsx(_,{}),onClick:()=>y("camera"),disabled:c||r.cameraState==="denied",size:h?"small":"medium",children:"Camera"}),e.jsx(v,{variant:l==="manual"?"contained":"outlined",startIcon:e.jsx(U,{}),onClick:()=>y("manual"),disabled:c,size:h?"small":"medium",children:"Manual Entry"})]})]}),e.jsx(V,{}),l==="camera"?e.jsxs(g,{children:[e.jsx(u,{variant:"subtitle2",sx:{mb:2,fontWeight:500},children:"Position barcode in camera view"}),e.jsxs(g,{sx:{position:"relative",width:"100%",height:h?"250px":"300px",border:"2px solid",borderColor:"primary.main",borderRadius:1,overflow:"hidden",bgcolor:"background.paper"},children:[e.jsx("div",{ref:i,style:{width:"100%",height:"100%",position:"relative"}}),r.cameraState==="active"&&e.jsx(u,{variant:"body2",color:"text.secondary",sx:{position:"absolute",bottom:8,left:"50%",transform:"translateX(-50%)",textAlign:"center",bgcolor:"rgba(0, 0, 0, 0.6)",color:"white",px:1,py:.5,borderRadius:1},children:"Point camera at barcode to scan"})]})]}):e.jsxs(g,{children:[e.jsx(u,{variant:"subtitle2",sx:{mb:2,fontWeight:500},children:"Enter Product Barcode"}),e.jsxs(E,{spacing:2,children:[e.jsx(G,{fullWidth:!0,label:"Barcode / SKU",value:x,onChange:a=>P(a.target.value),onKeyPress:S,disabled:c,placeholder:"Enter barcode or SKU...",variant:"outlined",autoFocus:l==="manual",InputProps:{startAdornment:e.jsx(B,{sx:{color:"text.secondary",mr:1}})}}),e.jsx(v,{variant:"contained",onClick:C,disabled:!x.trim()||c,startIcon:e.jsx(B,{}),size:"large",children:"Identify Product"})]})]}),e.jsx(Y,{feedback:M,visible:R,onHide:b,sx:{mt:2}})]})}),e.jsxs(Q,{sx:{px:3,pb:3},children:[e.jsx(u,{variant:"body2",color:"text.secondary",sx:{flexGrow:1},children:"Scan a product barcode to open its marketplace listing"}),e.jsx(v,{onClick:k,disabled:c,color:"primary",children:"Close"})]})]})};export{oe as ProductIdentificationScanner};
